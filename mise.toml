[tools]
node = '24.7.0'
pnpm = '10.19.0'
rust = '1.89.0'
tmux = '3.5'
uv = '0.8.14'

[tasks.bootstrap]
run = """
#!/bin/bash
WORKSPACE_ROOT=$PWD

cargo install --path tools/fqc --force
fqc bootstrap
cargo install diesel_cli --no-default-features --features postgres

cd $WORKSPACE_ROOT/backend/
diesel migration run
"""

[tasks.setup-hooks]
run = """
#!/bin/bash
set -e

echo "Setting up pre-commit hooks..."

# Check if uvx is available
if command -v uvx &> /dev/null; then
  echo "Using uvx to install pre-commit..."
  uvx pre-commit install
elif command -v python &> /dev/null || command -v python3 &> /dev/null; then
  echo "Using Python to install pre-commit..."
  PYTHON_CMD=$(command -v python3 || command -v python)

  # Ask for confirmation before installing
  read -p "pre-commit is not installed. Install it using pip? (y/N) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Install pre-commit using pip
    $PYTHON_CMD -m pip install --user pre-commit

    # Install the git hook
    $PYTHON_CMD -m pre-commit install
  else
    echo "Skipping pre-commit installation."
    exit 1
  fi
else
  echo "Error: Neither uvx nor Python is available. Please install one of them."
  exit 1
fi

echo "Pre-commit hooks installed successfully!"
"""

[tasks.build]
run = """
#!/bin/bash
cargo build
mise run build-plugins
cargo install --path tools/fqc --force
pnpm i --frozen-lockfile
pnpm -r run build
"""

[tasks.build-plugins]
run = """
#!/bin/bash
set -e

echo "Building WASM plugins..."

# Find all plugin directories with cdylib crate type
PLUGIN_DIRS=$(cargo metadata --format-version 1 --no-deps | \
  jq -r '.packages[] | select(.manifest_path | contains("plugins")) | select(.targets[0].crate_types[] == "cdylib") | .manifest_path | split("/") | .[:-1] | join("/")')

if [ -z "$PLUGIN_DIRS" ]; then
  echo "No WASM plugins found"
  exit 0
fi

# Build each plugin
for PLUGIN_DIR in $PLUGIN_DIRS; do
  echo "Building plugin in $PLUGIN_DIR..."
  cd "$PLUGIN_DIR"
  npm run build
  cd - > /dev/null
done

echo "All WASM plugins built successfully!"
"""

[tasks.dserve]
run = """
#!/bin/bash
if [ -z "$SKIP_PLUGINS" ]; then
  mise run build-plugins
fi
docker compose up --build --force-recreate -d
"""

[tasks.serve]
# TO DO: move script to fqc CLI
run = ["./tools/scripts/serve.sh"]

[tasks.stop]
# TO DO: move script to fqc CLI
run = """
#!/bin/bash
tmux kill-session -t flashqc
docker compose down
"""

[tasks.ci-astro]
run = """
#!/bin/bash
pnpm install --frozen-lockfile
pnpm --filter "flash-qc" exec astro check
pnpm --filter "flash-qc" build
"""

[tasks.ci-rust]
run = """
#!/bin/bash
export RUSTFLAGS="-Dwarnings"
cargo build
cargo test
cargo clippy --all-targets --all-features
"""

[tasks.ci]
depends = ["ci-astro", "ci-rust"]

[tasks.fmt]
run = """
#!/bin/bash
set -e

echo "Formatting all files..."

# Rust: rustfmt
echo "Formatting Rust files with rustfmt..."
cargo fmt --all

# Prettier: Astro/JSON/JSONC/CSS/etc
echo "Formatting Astro/JSON/JSONC/CSS files with prettier..."
npx --yes --package=prettier@3.6.2 --package=prettier-plugin-astro@0.14.1 \
  -- prettier --ignore-unknown --write '**/*.{astro,json,jsonc,css,scss,js,jsx,ts,tsx}'

# Markdown: markdownlint with auto-fix
echo "Formatting Markdown files with markdownlint..."
npx --yes --package=markdownlint-cli \
  -- markdownlint --fix '**/*.md' || true

# TOML: Taplo formatter
echo "Formatting TOML files with taplo..."
uvx taplo format

# SQL: sqlfluff fix
echo "Formatting SQL files with sqlfluff..."
uvx sqlfluff fix --dialect postgres || true

# YAML: yamlfix
echo "Formatting YAML files with yamlfix..."
uvx yamlfix . || true

echo "All files formatted successfully!"
"""

[tasks.lint]
run = """
#!/bin/bash
set -e

echo "Linting all files..."

# Rust: clippy
echo "Linting Rust files with clippy..."
export RUSTFLAGS="-Dwarnings"
cargo clippy --all-targets --all-features

# Prettier: check without writing
echo "Checking Astro/JSON/JSONC/CSS files with prettier..."
npx --yes --package=prettier@3.6.2 --package=prettier-plugin-astro@0.14.1 \
  -- prettier --ignore-unknown --check '**/*.{astro,json,jsonc,css,scss,js,jsx,ts,tsx}'

# Markdown: markdownlint
echo "Linting Markdown files with markdownlint..."
npx --yes --package=markdownlint-cli \
  -- markdownlint '**/*.md' || true

# TOML: Taplo lint
echo "Linting TOML files with taplo..."
uvx taplo lint

# SQL: sqlfluff lint
echo "Linting SQL files with sqlfluff..."
uvx sqlfluff lint --dialect postgres || true

echo "All files linted successfully!"
"""

[env]
DATABASE_URL = 'postgres://flashqc:1234@localhost/flashqc'
