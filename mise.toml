[tools]
node = '24.7.0'
pnpm = '10.19.0'
rust = '1.89.0'
tmux = '3.5'
uv = '0.8.14'

[tasks.bootstrap]
run = """
#!/bin/bash
WORKSPACE_ROOT=$PWD

cargo install --path tools/fqc --force
fqc bootstrap
cargo install diesel_cli --no-default-features --features postgres

cd $WORKSPACE_ROOT/backend/
diesel migration run
"""

[tasks.build]
run = """
#!/bin/bash
cargo build
cargo install --path tools/fqc --force
pnpm i --frozen-lockfile
pnpm -r run build
"""

[tasks.dserve]
run = ["docker compose up --build --force-recreate -d"]

[tasks.serve]
# TO DO: move script to fqc CLI
run = ["./tools/scripts/serve.sh"]

[tasks.stop]
# TO DO: move script to fqc CLI
run = """
#!/bin/bash
tmux kill-session -t flashqc
docker compose down
"""

[tasks.ci-astro]
run = """
#!/bin/bash
pnpm install --frozen-lockfile
# Type checking
pnpm --filter "@flash-qc/frontend" exec astro check
# Build
pnpm --filter "@flash-qc/frontend" run build
"""

[tasks.ci-rust]
run = """
#!/bin/bash
rustup component add clippy rustfmt
export RUSTFLAGS="-Dwarnings"
cargo clippy --all-targets --all-features
cargo fmt -- --check
"""

[tasks.ci]
depends = ["ci-astro", "ci-rust"]

[env]
DATABASE_URL = 'postgres://flashqc:1234@localhost/flashqc'
